# 観測とデバッグ

品質最優先のため、「なぜその記憶を選んだか」を追えるようにする。

## 残したいログ

- 検索計画（短いJSON）
- 候補収集の統計（件数、ソース別内訳）
- 採用結果（選んだもの、理由）
- 並列候補収集の実行情報（どれが遅いか）
- 記憶整理（chatターン回数ベース）の統計（対象件数、統合/過去化/要約更新、実行時間）
- 実行単位は `event_id` に紐づける

## 文脈グラフの観測

- 同期の仮置き（ルールベース）で何を張ったか
- 非同期の本更新（LLM）で何が変わったか（改訂履歴: `revisions`）

## 感情の観測

- `long_mood_state` の更新理由（改訂履歴: `revisions`）
- `event_affect`（瞬間/内心）が推定か、明示か

## 画像付きチャットの観測

- 画像そのものは保存しない（後から復元しない）
- 画像要約（詳細）は `events.image_summaries_json` に保存される（内部用、UI表示不要）
  - 要素が `""` の場合は「その画像を無視した」または「要約生成に失敗した」ことを表す
- `input_text` が空で画像がある場合は、内部的に `input_text="これをみて"` として扱う
- 入力が空（`input_text` 空 かつ 有効画像0枚）の場合は `/api/chat` が SSE の `event:error` を返す
  - 詳細は `docs/12_画像付きチャット.md` を参照

## 使い道

- 誤想起の原因追跡（どの候補が混入したか）
- 取りこぼしの原因追跡（候補収集が弱いか、選別が悪いか）
- ランキング調整（最近性/時間分散の効き方）
