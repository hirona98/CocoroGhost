# 観測とデバッグ

品質最優先のため、「なぜその記憶を選んだか」を追えるようにする。

## 残したいログ

- 検索計画（RetrievalPlan、短いJSON。ルール生成）
- 候補収集の統計（件数、ソース別内訳）
- entity展開（`entity_expand`）の観測（選んだentity、追加候補数、適用した閾値）
- 採用結果（選んだもの、理由）
- 実行単位は `event_id` に紐づける

## 体感速度の観測（まず見るべき行）

同期（SSE開始前）の体感は、主に「同期のLLM呼び出し時間」と「選別入力のサイズ」で決まる。

確認ポイント（例）:

- 埋め込み（検索クエリ）:
  - `LLM response 受信 【同期】＜＜ 記憶検索用クエリの埋め込み取得 ＞＞ ... ms=<N>`
- 選別入力サイズ:
  - `SearchResultPack selection input prepared candidates=<N> chars=<M>`
- SearchResultPack 選別:
  - `LLM response 受信 【同期】＜＜ 検索候補の選別（SearchResultPack） ＞＞ ... ms=<N>`
- 会話応答作成（SSE本文の生成）:
  - `LLM response 受信 【同期】＜＜ 会話応答作成 ＞＞ ... ms=<N>`

注記:

- `retrieval_max_candidates` / 経路クォータをいじった場合は、まず `candidates=<N>` と `chars=<M>` が変わっているかを見る。
- warnings（Pydantic等）は stderr ではなく logging に集約され、基本は1行になる（「壊れているように見える」出力を減らす）。

## 文脈グラフの観測

- 同期の仮置き（ルールベース）で何を張ったか
- 非同期の本更新（LLM）で何が変わったか（改訂履歴: `revisions`）

## 感情の観測

- `long_mood_state` の更新理由（改訂履歴: `revisions`）
- `event_affect`（瞬間/内心）が推定か、明示か

## 画像付きチャットの観測

- 画像そのものは保存しない（後から復元しない）
- 画像要約（詳細）は `events.image_summaries_json` に保存される（内部用、UI表示不要）
  - 要素が `""` の場合は「その画像を無視した」または「要約生成に失敗した」ことを表す
- `input_text` が空で画像がある場合は、内部的に `input_text="これをみて"` として扱う
- 入力が空（`input_text` 空 かつ 有効画像0枚）の場合は `/api/chat` が SSE の `event:error` を返す
  - 詳細は `docs/12_画像付きチャット.md` を参照

## 使い道

- 誤想起の原因追跡（どの候補が混入したか）
- 取りこぼしの原因追跡（候補収集が弱いか、選別が悪いか）
- ランキング調整（最近性/時間分散の効き方）
- 誤想起の自動分離（`searchable=0` や `event_affects` 削除）の発生有無確認
