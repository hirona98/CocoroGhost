# ログ解析用資料

このドキュメントでは、ログに出力される内容について説明する

※ `LlmRequestPurpose` は、LLM送受信ログに付与される「目的ラベル」です。
ログ中では `＜＜ ... ＞＞` の見出しとして出ます。


## タイミングログ（クライアント⇔LLM⇔クライアント）

「いつクライアントから要求が来たのか」「LLMにいつ送ったのか」「いつ返し始め、いつ終わったのか」が分かるように、時系列ログを出す。  
目的は**順番と時間差の把握**で、ペイロードは出さない方針です。

出力されるイベントは次の通り
- クライアント受信  
- クライアント不正リクエスト / クライアント要求エラー / クライアント応答エラー  
- LLM送信開始 / LLM送信完了 / LLM送信エラー  
- LLMストリーム終了 / LLMストリームエラー  
- クライアント送信開始 / クライアント送信終了

```
タイミング event=クライアント受信 request_id=... 経過ms=0
```

ストリームの場合は「送信開始」と「送信終了」が必ず分かるようにしているため、**配信の開始/終了タイミングが追える**状態になっている。


## 埋め込みログ（記憶検索用クエリ）

`＜＜ 記憶検索用クエリの埋め込み取得 ＞＞`

種別: 埋め込み（Embedding）呼び出し

呼び出しタイミング: 会話毎（同期）

  - 記憶検索のための2つの検索文（短文＋文脈付き）を埋め込みに送った
  - この埋め込みは記憶検索（Retriever）の検索キーを作るために行う
  - 2本のクエリ（短文＋文脈付き）のベクトルを得る
  - ベクトルDBから取得した関連エピソードをMemoryPack（内部コンテキスト）に入れる


## エンティティ名抽出ログ（names only）

`＜＜ エンティティ（実体）名抽出 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（同期）

  - MemoryPack 生成時に常時使うLLM抽出（names only）のログです。
  - 固有名が無ければ空配列になり、その後の MemoryPack には影響しない。
  - 「わからないことは遠慮なく訊いてね。」のような文では、期待される返答は `{"names":[]}` です。  


## 会話応答ログ（会話本文の生成）

`＜＜ 会話応答作成 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（同期）

  - 通常のチャット返答（人格の本文）を生成しているログです。
  - MemoryPack（内部コンテキスト）や直近会話、画像要約などを材料にして応答を作ります。


## 通知返答ログ

`＜＜ 通知返答 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 通知依頼時

  - 外部から入ってきた通知を、人格の返答（ユーザーに見える本文）に変換しているログです。
  - 通知文（`# notification` ブロック）と必要なら画像要約を材料に、MemoryPack を使って自然な返答にします。


## メタ要求対応ログ（割り込み）

`＜＜ メタ要求対応 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: メタ要求時

  - 「割り込み指示（instruction）＋ペイロード（payload）」から能動メッセージを生成しているログです。
  - 方針として、instruction/payload は永続化せず、生成された本文だけが Episode として保存されます。
    - ログでは「メタ要求が来た」ことは追えますが、記憶としては本文だけが残ります。


## 内的思考ログ（反射）

`＜＜ 内的思考（反射） ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - 会話の裏側で、反射（salience / confidence / persona_affect / topic_tags など）をJSONとして抽出するログです。
  - ユーザーに見える本文ではなく、内部メタデータ更新が目的です。


## エンティティ抽出ログ

`＜＜ エンティティ（実体）抽出 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - エピソードから「人物/話題などの実体（Entity）」と、その関係（Relation）を抽出するログです。
  - 結果は人物/トピックのサマリ更新（後述）の enqueue にも使われます。


## 事実抽出ログ

`＜＜ 事実抽出 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - エピソードから Fact（主語・述語・目的語の三つ組）を抽出するログです。
  - 抽出結果は Fact Unit として保存され、検索用に埋め込み（UNIT_EMBEDDING）も作られます。


## 未完了事項抽出ログ

`＜＜ 未完了事項抽出 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - エピソードから「未完了のTODO/約束/宿題」などを抽出するログです。
  - 出力は open loops のみで、クローズ判断はサーバ側のTTL/更新に寄せています。


## 背景共有サマリ生成ログ

`＜＜ 背景共有サマリ生成 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - 一定期間のエピソードをまとめ、共有状態（shared narrative）をJSON要約するログです。
  - 目的は、会話の継続性を保つための「背景」を圧縮して持つことです。
  - 直近7日分のサマリが更新されます。


## 人物サマリ生成ログ

`＜＜ 人物サマリ生成 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - roles に `person` を持つ Entity について、関連エピソードを集約して人物要約を作るログです。
  - favorability（好感度）などの付帯情報もここで生成します。


## トピックサマリ生成ログ

`＜＜ トピックサマリ生成 ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - roles に `topic` を持つ Entity について、関連エピソードを集約して話題要約を作るログです。
  - 検索・会話の一貫性のために、話題の「いまの状態」を圧縮して保持します。


## ユニット埋め込みログ

`＜＜ ユニット埋め込み ＞＞`

種別: 埋め込み（Embedding）呼び出し

呼び出しタイミング: 会話毎（バックグラウンド）

  - Unit（Episode / Fact / Loop / Summary など）を検索できるように、埋め込みベクトルを作るログです。
  - 目的は Retrieval（類似検索）のための検索インデックス更新です。


## 画像要約ログ（会話）

`＜＜ 画像要約（会話） ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: 会話毎（同期）

  - チャット入力に画像がある場合、その画像をテキスト要約に変換して以降の処理の材料にします。
  - 画像のみ送られた場合でも、会話生成が安定するように要約を入力に混ぜます。


## 画像要約ログ（通知）

`＜＜ 画像要約（通知） ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: その他

  - 通知に添付された画像を要約し、通知返答生成の材料にします。


## 画像要約ログ（メタ要求対応）

`＜＜ 画像要約（メタ要求対応） ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: その他

  - メタ要求に添付された画像を要約し、メタ要求の本文生成の材料にします。
  - instruction/payload 自体は永続化しない方針ですが、画像要約は生成材料として利用します。


## 画像要約ログ（デスクトップウォッチ）

`＜＜ 画像要約（デスクトップウォッチ） ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: その他

  - デスクトップキャプチャ画像を要約し、能動コメント生成の材料にします。


## デスクトップウォッチログ

`＜＜ デスクトップウォッチ ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: その他

  - ユーザー発話ではない能動イベントとして、デスクトップ状態を確認してコメントを生成するログです。
  - Unit.source="desktop_watch" として保存され、通常会話と区別されます。


## リマインダーログ

`＜＜ リマインダー ＞＞`

種別: 通常LLM呼び出し

呼び出しタイミング: その他

  - 指定時刻・内容から、人格のリマインダー文面を生成するログです。
  - memory_enabled=false の場合は保存せず配信のみ、true の場合は Episode として保存されます。
