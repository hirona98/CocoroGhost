# 記憶モデル

この設計では、記憶を「追加しかされないログ」と「更新される状態」に分ける。

## 1) 出来事ログ（`events`）

- 会話・通知・視覚要約・リマインダーなど、すべてを **ターン単位**で追記する
- 出来事ログは削除しない（忘れない）
- 出来事ログは「観測された事実」であり、矛盾があってもそのまま残す
- 画像は保持しない（**画像の説明テキスト**だけを残す）
  - 画像付きチャットでは `events.image_summaries_json` に「画像ごとの詳細要約（JSON配列）」を保存する（内部用、UI表示不要）

補足:

- `meta-request` は外部要求だが、要求内容は記録しない
- ただし、要求をきっかけに AI 人格が「自分で思いついて動いた」結果（出来事ログ）は残す（`events.source="meta_proactive"` として区別する）

### ターン単位でまとめる

メッセージ単位ではなく、1ターン（ユーザー入力 + アシスタント出力）を基本単位にする。

## 2) 状態

状態は「将来の会話のために育つ」読み物/知識の層。
出来事ログ（`events`）から抽出され、更新される。
状態本文（`state.body_text`）はAI人格本人の主観で統一する

状態の種類（最小セット）:

- 事実（`kind="fact"`）: 好み、設定、プロフィール、恒常的な情報
- 関係（`kind="relation"`）: 人/話題の関連づけ
- タスク（`kind="task"`）: 未完了・完了
- 要約（`kind="summary"`）: 人物/話題/期間などの圧縮
- 長期感情（`kind="long_mood_state"`）: 背景として持続する感情

保存は単一テーブル `state` にまとめ、`kind` と `payload_json` で表現する。

## 2.5) 確定プロフィール（好み/苦手: `user_preferences`）

会話中に「好き/苦手」を話題にしやすくしつつ、誤断定（架空の好み/苦手）を減らすために、
好み/苦手だけを専用テーブルで管理する。

方針:

- 対象は **好み/苦手**のみ（性格/習慣（例: 「いつも」「丁寧な人」）は扱わない）
- domain は 3種に固定する
  - `food`（食べ物）
  - `topic`（話題）
  - `style`（会話スタイル）
- polarity は 2種に固定する
  - `like`
  - `dislike`
- 状態（status）は次の3種
  - `candidate`: 候補（断定の根拠にしない）
  - `confirmed`: 確定（会話で断定して良い根拠）
  - `revoked`: 取り消し（過去は残すが現在は無効）

注記:

- 会話生成で「好き/苦手」を断定して良いのは `confirmed` のみとする
- `candidate` は「確認の材料」にはしてよいが、断定の根拠にはしない
- `user_preferences` の更新は `revisions` に残し、後から追えるようにする

## 3) 改訂履歴（`revisions`）

状態は更新されるため、**何がどう変わったか**を必ず履歴として残す。

- 変更前のスナップショット
- 変更後のスナップショット
- 変更理由（短文）
- 根拠イベント（`event_id`）（複数可）

注記:

- 出来事ログ（`events`）に直結する更新では、根拠イベントは **空にしない**（現在の `event_id` を含める）
- 定期整理（`tidy_memory`）のようにイベント直結でない更新では、根拠イベントが空になる場合がある

## 重要: 状態は「並存」しうる

人間の記憶では「同じ種類のこと」でも時系列で変わる。
そのため、状態は1つに上書きせず、必要なら複数並存させる（有効期間や確認時刻を持つ）。

### `kind` ごとの並存可否

| kind | 並存可否 | 備考 |
|------|---------|------|
| fact | 並存可 | 時期によって変わりうる（例: 住所） |
| relation | 並存可 | 関係は複数存在しうる |
| task | 並存可 | タスクは複数 |
| summary | 並存可 | 現状はスコープ設計を扱わない（必要になったら挙動ベースで追加する） |
| long_mood_state | **単一** | 背景感情は1件を更新で育てる（増殖させない） |

## 4) 文脈グラフ（`event_threads` / `event_links`）

出来事ログ（`events`）同士の関係を持つ派生情報。
「なんの流れ（文脈）だっけ？」を追えるようにするために、保存して育てる。

- `event_links`: `reply_to` / `same_topic` / `caused_by` などの関係（イベント→イベント）
- `event_threads`: イベントを「文脈スレッド」に所属させる情報（イベント→スレッド）

同期（返答前）でやるのは、**`reply_to = 直前イベント` の仮置きだけ**にする。
分割/統合や補正は非同期（`WritePlan`）で本更新する。

## 5) 感情（`long_mood_state` / `event_affects`）

「人間っぽさ」を上げるために、感情を2層で扱う（長期 + 瞬間）。

注記:

- DBのテーブル名は `event_affects`（複数形）だが、概念としては「event_affect（イベントごとの瞬間感情）」として説明する。

### 採用方針（正）

- 数値は **VAD（快・不快/覚醒/主導）** を正とする（各軸 **-1.0..+1.0**）
- ただし VAD だけでは表現が足りないため、**ラベルとテキスト**を必ず併用する
- つまり保存の正は **VAD + ラベル + テキスト** とする
- 感情テキストはAI人格の主観で統一する（自分は「私」、ユーザーは「あなた」）
- 通常の会話応答（ユーザーに見せる本文）はセリフ中心にする（感情ログは本文に出さない）

### 5-1) 長期的な感情（`long_mood_state`）

「最近ずっとどんより」など、背景として持続する層。返答トーンに影響しうる。

設計方針:

- 同期の返答生成では `LongMoodState` として内部注入し、背景として常に参照できるようにする（`SearchResultPack` の選別に依存させない）
- **状態として更新で育つ**（更新は `revisions` に残す）
- `long_mood_state` は原則 **1件** を更新で育てる（増殖させない）
- 形式は **文章＋数値（VAD）** を両方持つ

LongMoodState の2層（baseline + shock）:

- baseline（基調）: 日スケールでゆっくり更新する（背景が毎ターン反転しないようにする）
- shock（余韻）: 重大な出来事は次ターン以降にすぐ効かせつつ、時間で減衰させる

### 5-2) 瞬間的な感情（`event_affect`）

「ちょっとフフッって笑う」など、そのターンの瞬間反応。

設計方針:

- イベント（`event_id`）に紐づけて保存する（追記ログとして残せる）
- 形式は **文章＋数値（VAD）** を両方持つ
- 「推定か明示か」を運用で選べるよう、必ず `confidence` を持つ

分量ガイド（推奨）:

- `moment_affect_text`: 1〜3文、60〜240文字（「何を見て/何が起きて/どう感じたか」が分かる粒度）
- `moment_affect_labels`: 0〜6件（短いラベル。基本は1〜3件）

## 6) 時間モデル（最近性 / `about_time` / `life_stage`）

記憶の「いつ」は1軸では足りない。この設計では最低でも次を使う。

### 6-1) 最近性

「最近話題に上がった」軸。無意識の連想では、基本的に最近のものが優先される。

- 出来事ログ（`events`）: `created_at`（そのターンが記録された時刻）
- 状態: `last_confirmed_at`（直近で確認/更新された時刻）

補足:

- 「流れ（なんの文脈だっけ？）」の追跡には、文脈グラフ（`event_threads` / `event_links`）を参照する

### 6-2) 時刻表現（DBとLLMの役割分担）

結論:

- DB内部: UNIX秒（UTC、整数）を正とする（比較/並び替え/範囲検索が安定する）
- LLM入出力: ISO 8601（ローカル時刻、タイムゾーン表記なし）を正とする（読みやすさ優先）

注記:

- タイムゾーン表記が無い日時は「ローカル時刻」とみなしてUTCへ変換する
- JSON上のキー名は `created_at` など既存名を使い、値だけを ISO 8601 文字列にする（例: `"created_at": "2026-01-10T14:06:59"`）

### 6-3) `about_time`（内容がいつの話か）

出来事の内容が「いつの話か」を推定する。ユーザー指定（例: 高校の頃、2018年）にも対応する。

- 日付レンジ（UTC秒）: `about_start_ts`〜`about_end_ts`
- 年レンジ: `about_year_start`〜`about_year_end`
- ライフステージ: `life_stage`

推定には必ず `about_time_confidence` を付ける（断定しない）。

### 6-4) `life_stage`（全期間横断の分散）

「学校で…」のような検索では、小中高などを同レベルで拾える必要がある。
そのため候補生成時に `life_stage`（や年バケット）で分散させる。
