# 記憶モデル

この設計では、記憶を「追加しかされないログ」と「更新される状態」に分ける。

## 1) 出来事ログ（`events`）

- 会話・通知・視覚要約・リマインダーなど、すべてを **ターン単位**で追記する
- 出来事ログは削除しない（忘れない）
- 出来事ログは「観測された事実」であり、矛盾があってもそのまま残す
- 画像は保持しない（**画像の説明テキスト**だけを残す）
  - 画像付きチャットでは `events.image_summaries_json` に「画像ごとの詳細要約（JSON配列）」を保存する（内部用、UI表示不要）

補足:

- `meta-request` は外部要求だが、要求内容は記録しない
- ただし、要求をきっかけに AI 人格が「自分で思いついて動いた」結果（出来事ログ）は残す（`events.source="meta_proactive"` として区別する）

### ターン単位でまとめる

メッセージ単位ではなく、1ターン（ユーザー入力 + アシスタント出力）を基本単位にする。

## 2) 状態

状態は「将来の会話のために育つ」読み物/知識の層。
出来事ログ（`events`）から抽出され、更新される。
状態本文（`state.body_text`）はAI人格本人の主観で統一する

状態の種類（最小セット）:

- 事実（`kind="fact"`）: 好み、設定、プロフィール、恒常的な情報
- 関係（`kind="relation"`）: 人/話題の関連づけ
- タスク（`kind="task"`）: 未完了・完了
- 要約（`kind="summary"`）: 人物/話題/期間などの圧縮
- 長期感情（`kind="long_mood_state"`）: 背景として持続する感情

保存は単一テーブル `state` にまとめ、`kind` と `payload_json` で表現する。

## 3) 改訂履歴（`revisions`）

状態は更新されるため、**何がどう変わったか**を必ず履歴として残す。

- 変更前のスナップショット
- 変更後のスナップショット
- 変更理由（短文）
- 根拠イベント（`event_id`）（複数可）

注記:

- 出来事ログ（`events`）に直結する更新では、根拠イベントは **空にしない**（現在の `event_id` を含める）
- 定期整理（`tidy_memory`）のようにイベント直結でない更新では、根拠イベントが空になる場合がある

## 重要: 状態は「並存」しうる

人間の記憶では「同じ種類のこと」でも時系列で変わる。
そのため、状態は1つに上書きせず、必要なら複数並存させる（有効期間や確認時刻を持つ）。

### `kind` ごとの並存可否

| kind | 並存可否 | 備考 |
|------|---------|------|
| fact | 並存可 | 時期によって変わりうる（例: 住所） |
| relation | 並存可 | 関係は複数存在しうる |
| task | 並存可 | タスクは複数 |
| summary | 並存可 | 現状はスコープ設計を扱わない（必要になったら挙動ベースで追加する） |
| long_mood_state | **単一** | 背景感情は1件を更新で育てる（増殖させない） |

## 4) 文脈グラフ（`event_threads` / `event_links`）

出来事ログ（`events`）同士の関係を持つ派生情報。
「なんの流れ（文脈）だっけ？」を追えるようにするために、保存して育てる。

- `event_links`: `reply_to` / `same_topic` / `caused_by` などの関係（イベント→イベント）
- `event_threads`: イベントを「文脈スレッド」に所属させる情報（イベント→スレッド）

同期（返答前）でやるのは、**`reply_to = 直前イベント` の仮置きだけ**にする。
分割/統合や補正は非同期（`WritePlan`）で本更新する。

## 5) 感情（`long_mood_state` / `event_affects`）

感情は「長期」と「瞬間」を分けて保存する。

- `long_mood_state`: 長期的な感情（状態として更新で育つ。更新は `revisions` に残す）
- `event_affects`: 瞬間的な感情（`event_id` に紐づけた追記ログ）

保存の正は **文章＋数値（VAD: -1.0..+1.0）** とする（詳細は `docs/09_感情.md`）。
