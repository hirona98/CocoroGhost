# 記憶更新（育てる）

返答とは別に、出来事ログから「状態」を育てる。
ここは品質最優先でよい（非同期）。

補足:

- 同期/非同期のジョブの繋がりは `docs/10_実行フロー.md` を参照

## 入力

- 対象の出来事ログ（ターンログ）
- 直近の関連状態（必要な範囲）

## 出力（更新計画）

- 出来事ログへの注釈（`about_time`、`entities`、話題など）
- 状態（`state`）の更新（`upsert`/`close`/`mark_done` など）
- 変更理由と根拠イベント（必須）

## 更新計画（`WritePlan`）

目的:

- 出来事ログから「状態」「文脈グラフ」「感情」をどう更新するかを決める
- 更新を必ず根拠イベントと紐づけ、改訂履歴（`revisions`）に記録できる形にする

出力例（概略）:

```json
{
  "event_annotations": {
    "about_start_ts": null,
    "about_end_ts": null,
    "about_year_start": null,
    "about_year_end": null,
    "life_stage": "elementary|middle|high|university|work|unknown",
    "about_time_confidence": 0.0,
    "entities": [{"type": "PERSON", "name": "string", "confidence": 0.0}]
  },
  "state_updates": [
    {
      "kind": "fact|relation|task|summary|long_mood_state",
      "op": "upsert|close|mark_done",
      "state_id": null,
      "body_text": "string",
      "payload": {},
      "confidence": 0.0,
      "salience": 0.0,
      "valid_from_ts": null,
      "valid_to_ts": null,
      "last_confirmed_at": 0,
      "evidence_event_ids": [123],
      "reason": "string"
    }
  ],
  "event_affect": {
    "moment_affect_text": "string",
    "moment_affect_score_vad": {"v": 0.0, "a": 0.0, "d": 0.0},
    "moment_affect_confidence": 0.0,
    "inner_thought_text": null
  },
  "context_updates": {
    "threads": [{"thread_key": "string", "confidence": 0.0}],
    "links": [{"to_event_id": 456, "label": "reply_to|same_topic|caused_by", "confidence": 0.0}]
  }
}
```

注記:

- `*_score_vad.v/a/d` は **-1.0..+1.0** に固定する
- `context_updates` は「文脈グラフを育てる」ための派生更新（不要なら空でもよい）
- 文脈グラフの更新は「同期の仮置き」と「非同期の本更新」に分ける（詳細は `docs/06_ストレージ（SQLite）.md`）
- 出力は「JSONのみ」とする（前後に説明文を付けない）

## 更新の原則

- 更新には根拠イベントが必須（`evidence_event_ids` に必ず含める）
- 矛盾がある場合は「上書き」ではなく並存/期間分割を優先する
- 「最近のほうを強く」は、`last_confirmed_at` を更新し検索順位に反映する

## 感情の更新

感情は2系統で更新する（詳細は `docs/09_感情.md`）。

- 長期的な感情（`long_mood_state`）: 会話の進行に応じて更新し、改訂履歴（`revisions`）に残す
- 瞬間的な感情/内心（`event_affect`）: 対象イベントに紐づけて保存する

## 要約（`state.kind="summary"`）の扱い

会話ログはすべて残るが、そのままでは重いので要約（`state.kind="summary"`）を育てる。

- 人物/話題/期間/文脈スレッドごとの要約（`payload` に scope を持たせる）
- ローリング要約（例: 直近30日）
- 更新は履歴として残す（なぜ変えたか）
