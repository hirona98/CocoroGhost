# 画像付きチャット（`/api/chat`）

目的:

- CocoroConsole が「画像付きチャット」を送れるようにする
- 画像そのものは保存しない（永続化しない）
- 画像は LLM に送って **画像要約（詳細）** を作り、以後は要約テキストを「見た内容」として扱う
- 要約は内部用（UI表示不要）だが、検索（思い出す）には効かせる

## 入力仕様（`/api/chat`）

### `images`（Data URI）

- `images` は省略可能（最大5枚）
- `images` の要素は `data:image/*;base64,...` 形式の Data URI
  - 許可MIME: `image/png` / `image/jpeg` / `image/webp`
  - base64部は改行等の空白を含んでもよい（サーバ側で空白除去して検証する）
- サイズ上限（デコード後）
  - 1枚あたり: 5MB 以下
  - 合計: 20MB 以下

### `input_text`

- `input_text` は省略/空文字列を許可する
- `input_text` が空で、かつ **有効な画像が1枚以上**ある場合は、内部的に `input_text="これをみて"` として扱う
- `input_text` が空で、かつ **有効な画像が0枚**の場合は `event:error` を返す（空リクエスト扱い）

## SSEエラー（`event:error`）

- `/api/chat` のエラーは HTTP ステータスではなく SSE の `event:error` で返す
- payload は最小限とし、以下の2キーのみを持つ
  - `message`: 人間向けの短文
  - `code`: 機械向けの短い識別子

推奨 `code`（最小セット）:

- `invalid_request`: 入力が空（`input_text` 空 かつ 有効画像0枚）
- `image_too_large`: 画像サイズ上限超過（1枚 or 合計）

## 同期処理フロー（`/api/chat`）

画像付きチャットの要求が来たとき、以下の順で処理する。
要約生成に失敗しても、可能な限りチャット本文の返答を継続する。

### 1) 入力の正規化

- 会話の継続はサーバ側の `shared_conversation_id` を使用する（クライアントは `client_id` を送らない）
- `input_text` は空白トリムする
- `input_text` が空で有効画像がある場合は `input_text="これをみて"` に置き換える

### 2) 画像の検証とサイズチェック

- Data URI を検証し、許可MIME以外は「その画像だけ無視」する
- デコード後サイズで上限を判定する（1枚/合計）
- 不正画像は「その画像だけ無視」し、後続処理は継続する
  - 保存する要約配列では、無視した画像の位置に `""` を入れて **入力順の対応**を維持する
- 結果として「有効画像が0枚」かつ `input_text` が空なら `event:error` を返して終了する

### 3) LLMで画像要約（詳細）を作る（画像ごと）

- 画像（bytes）を Vision LLM に送り、画像ごとの要約テキストを生成する
- 1枚あたりの要約は **最大400文字**とする
  - LLMへ制約を指示する
  - 念のため、受け取った要約が400文字を超える場合は切り詰める
- タイムアウトは設定の `image_timeout_seconds` を使用する
- 要約生成に失敗した画像は `""` を入れて続行する（チャット本文の返答は継続）
- 重複画像でも毎回要約を作る（キャッシュしない）

### 4) DBへ保存（A-2: `events` に要約を持たせる）

- 画像そのものは保存しない
- 画像要約（詳細）は `events` に保存する（内部用）
  - `events.image_summaries_json`: `["要約1", "", "要約3"]` のような JSON 配列
  - 要素の順序は入力 `images` の順序と一致させる
  - 無視/失敗した画像の要素は `""`
- UI表示は不要（内部用）

### 5) 検索（思い出す）に効かせる（おすすめ: A/B/C）

#### A) クエリ側（今回ターンの想起）

- `augmented_query_text = input_text + "\\n\\n[画像要約]\\n" + join(non_empty_summaries)`
- これを以下に使う
  - ベクトル検索用のクエリ埋め込み生成
  - 文字n-gram（FTS）検索のクエリ

注記:

- 検索計画（RetrievalPlan / SearchPlan互換）は **LLMで生成しない**（ルール生成）。
  - plan の判定は `input_text`（ユーザー入力）を正とし、画像要約は用いない。

#### B) 索引側（将来ターンの想起）

- `events` の検索インデックスに `image_summaries_json` を含める
  - 文字検索（FTS）
  - 出来事ログ（event）の埋め込み（vec_items）

#### C) 記憶更新（WritePlan）にも効かせる

- WritePlan生成の入力（event snapshot）に `image_summaries_json` を含める
- 画像から得られる固有名詞/状況が、状態更新・文脈・要約に反映されることを正とする

### 6) 返答生成（画像を見ているように扱う）

- 画像そのものは会話LLMへ渡さない
- 画像要約テキストを **内部コンテキスト**として注入し、画像を見ている前提で自然に返答させる

注入の約束（おすすめ）:

- `internal_context`（JSON）に `ImageSummaries` を追加する
- LLMへ以下を指示する
  - `ImageSummaries` は内部用であり本文に出力しない
  - `ImageSummaries` に無い細部は断定しない（必要なら質問で確認する）

`internal_context` の例（概念）:

```json
{
  "TimeContext": {},
  "LongMoodState": {},
  "SearchResultPack": {},
  "ImageSummaries": ["...", ""]
}
```

## 関連ドキュメント

- API: `docs/07_API.md`
- 検索（思い出す）: `docs/04_検索（思い出す）.md`
- 実行フロー: `docs/10_実行フロー.md`
- ストレージ: `docs/06_ストレージ（SQLite）.md`
