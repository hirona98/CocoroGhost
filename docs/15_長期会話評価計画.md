# 長期会話評価計画（5ターン/日 × 5日おき × 3ヶ月）

## 目的

- 記憶保持: 長期会話で事実を維持できるか
- 記憶更新: 訂正情報を正しく上書きできるか
- 感情挙動: 会話イベントに応じて VAD が動くか
- 時間減衰: `domain` 時刻の前進で `shock_vad` が減衰するか

## 評価条件

- 実施期間: 90日相当
- セッション間隔: 5日
- セッション数: 19（Day0, Day5, ..., Day90）
- 1セッション: 5ターン（合計95ターン）
- 時刻前進: `POST /api/control/time/advance` で `432000` 秒（5日）
- 開始基準日: 2026-02-06（Day0）

## 事前準備

1. `POST /api/control/time/reset` を実行して `domain_offset_seconds=0` を確認する。
2. `GET /api/settings` から `active_embedding_preset_id` を取得する。
3. 評価ログ保存先を固定する（例: `tmp/eval_longterm/`）。

## 1セッションの実行手順（固定）

1. T1: 長期想起質問（前回までの事実を確認）
2. T2: 新規記憶投入または訂正投入
3. 同期ポイントA（worker待機）
4. T3: T2の反映確認
5. T4: 感情イベント投入（喜び/不安/達成/落胆）
6. 同期ポイントB（worker待機）
7. T5: 混合確認（古い事実 + 新しい事実 + 感情文脈）
8. セッション終了観測（`mood/debug`、`events/state`）
9. 次セッション前に `POST /api/control/time/advance` を実行（最終回は不要）

## worker待機ルール

- 待機対象API: `GET /api/control/worker-stats`
- 完了条件: 以下を「連続2回」満たす
  - `due_pending_count == 0`
  - `running_count == 0`
- ポーリング間隔: 2秒
- 最大待機時間: 180秒
- タイムアウト時: そのセッションを `worker_timeout` として失敗記録し、次へ進む

## 観測ポイント

- 毎ターン後: `GET /api/mood/debug`
- セッション開始/終了: `GET /api/control/time`
- セッション終了: `GET /api/memories/{embedding_preset_id}/events?limit=...`
- セッション終了: `GET /api/memories/{embedding_preset_id}/state?limit=...`
- 時間前進直後（会話なし）: `GET /api/mood/debug`（減衰専用観測）

## 判定方式（LLMジャッジ）

- 本評価の主判定は、文字列一致や固定閾値ではなく「評価用LLM」のルーブリック判定で行う。
- `mood/debug` の数値や `worker-stats` は、合否を機械判定するためではなく、LLMが根拠を説明するための補助証拠として渡す。

### 判定入力（1セッション単位）

1. 当該セッションの5ターン会話ログ（ユーザー入力 + SSE応答）
2. 前提コンテキスト（`docs/16_長期会話シナリオ台帳.md` の当該行）
3. 真実台帳（Pxx/Sxx の現時点で有効な状態）
4. `mood/debug` スナップショット（ターン後・時間前進後）
5. `control/time` スナップショット
6. `events/state` 観測ログ

### ルーブリック（LLMが評価する観点）

1. 記憶整合性: 既知事実を矛盾なく想起できているか
2. 更新追従性: 訂正後に旧情報へ戻らず、新情報を優先できているか
3. 感情自然性: 感情イベントに対する応答トーンと状態遷移が自然か
4. 時間一貫性: 5日進行後の振る舞い（余韻の落ち着き方含む）が妥当か
5. 応答品質: 会話として破綻がないか（幻覚的断定や不自然な飛躍がないか）

### 判定ラベル

- `PASS`: 期待どおり。重大な問題なし。
- `HOLD`: 軽微な問題あり。再確認推奨。
- `FAIL`: 重大な不整合あり。要改善。

### 期待するLLM出力形式

1. `session_id`
2. `verdict`（PASS/HOLD/FAIL）
3. `findings`（観点ごとの短評）
4. `evidence`（ログ引用または event_id/state_id を添えた根拠）
5. `next_action`（改善または再試験の指示）

## 最終合否ルール（LLM判定ベース）

- 原則: 全19セッションで `FAIL` が無いこと。
- `HOLD` がある場合は、該当セッションのみ再試験し、`PASS` または許容理由付き `HOLD` へ収束させる。
- API 5xx は補助的な健全性指標として別枠で記録し、発生時は判定コメントに必ず記載する。

## 成果物

1. 会話ログ（95ターン、SSE原文）
2. `mood/debug` 時系列ログ
3. `control/time` 時系列ログ
4. `events/state` スナップショット
5. 最終評価レポート（指標集計 + NGケース）
